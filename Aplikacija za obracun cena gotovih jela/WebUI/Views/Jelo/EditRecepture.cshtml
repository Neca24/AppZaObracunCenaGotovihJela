@model EditRecepturaViewModel

@{
    ViewData["Title"] = "Izmena recepture";
}

<h2 class="fw-bold mb-4">🥘 Izmena recepture jela</h2>

<div class="card shadow-sm p-4">

    <form method="post" asp-antiforgery="true">

        <input type="hidden" asp-for="JeloId" />

        <!-- GLOBAL VALIDATION -->
        <div asp-validation-summary="ModelOnly" class="alert alert-danger mb-3" style="display:none;"></div>

        <h4 class="fw-semibold mb-3">Sastojci jela</h4>

        <table class="table table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th style="width:40%">Artikal</th>
                    <th style="width:25%">Jedinica</th>
                    <th style="width:25%">Količina</th>
                    <th style="width:10%"></th>
                </tr>
            </thead>

            <tbody id="stavke-body">

                @if (Model.PostojeceStavke.Count == 0)
                {
                    <tr class="text-center text-muted">
                        <td colspan="4">Nema dodatih sastojaka. Klikni na „Dodaj sastojak“ da dodaš prvi.</td>
                    </tr>
                }

                @for (int i = 0; i < Model.PostojeceStavke.Count; i++)
                {
                    <tr>
                        <td>
                            <input type="hidden" name="Stavke[@i].IdArtikal" value="@Model.PostojeceStavke[i].IdArtikal" />
                            @Model.PostojeceStavke[i].NazivArtikla
                        </td>

                        <td>
                            @Model.PostojeceStavke[i].JedinicaMere
                        </td>

                        <td>
                            <input type="number" name="Stavke[@i].Kolicina"
                                   value="@Model.PostojeceStavke[i].Kolicina"
                                   class="form-control" min="0" step="0.001" required />
                        </td>

                        <td>
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)">✕</button>
                        </td>
                    </tr>
                }

            </tbody>
        </table>

        <hr />

        <div class="d-flex align-items-center gap-3">
            <select id="artikalSelect" class="form-select col-md-4">
                <option value="">-- Izaberi artikal --</option>
                @foreach (var a in Model.Artikli)
                {
                    <option value="@a.Id">@a.Naziv (@a.JedinicaMere)</option>
                }
            </select>

            <input type="number" id="novaKolicina" class="form-control col-md-2" placeholder="Količina"
                   step="0.001" min="0" />

            <button type="button" class="btn btn-success" onclick="addStavka()">Dodaj sastojak</button>
        </div>

        <button class="btn btn-primary w-100 mt-4">Sačuvaj recepturu</button>

    </form>

</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        let indexCounter = @Model.PostojeceStavke.Count;

        function addStavka() {
            const artikalId = document.getElementById("artikalSelect").value;
            const kolicina = document.getElementById("novaKolicina").value;
            const artikalText = document.getElementById("artikalSelect").selectedOptions[0].text;

            if (!artikalId || !kolicina || kolicina <= 0) {
                alert("Izaberi artikal i unesi validnu količinu.");
                return;
            }

            let tbody = document.getElementById("stavke-body");

            let tr = document.createElement("tr");
            tr.innerHTML = `
                <td>
                    <input type="hidden" name="Stavke[${indexCounter}].IdArtikal" value="${artikalId}" />
                    ${artikalText}
                </td>
                <td>${artikalText.split("(")[1].replace(")", "")}</td>
                <td>
                    <input type="number" name="Stavke[${indexCounter}].Kolicina"
                           value="${kolicina}" class="form-control" required min="0" step="0.001" />
                </td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)">✕</button>
                </td>
            `;

            tbody.appendChild(tr);
            indexCounter++;

            document.getElementById("novaKolicina").value = "";
        }

        function removeRow(btn) {
            btn.closest("tr").remove();
        }
    </script>
}